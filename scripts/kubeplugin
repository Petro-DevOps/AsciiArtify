#!/bin/bash

# Remove plugin name if present
if [[ "$0" == *"kubectl-kubeplugin.sh" ]]; then
  shift
fi

set -e

if ! command -v kubectl &> /dev/null; then
  echo "kubectl not found. Please install it first."
  exit 1
fi

if [[ $# -lt 3 ]]; then
  echo "Usage: kubectl kubeplugin <resource> -n <namespace>"
  exit 1
fi

RESOURCE="$1"
shift

while [[ $# -gt 0 ]]; do
  case "$1" in
    -n|--namespace)
      NAMESPACE="$2"
      shift 2
      ;;
    *)
      shift
      ;;
  esac
done

if [[ -z "$NAMESPACE" ]]; then
  echo "Namespace not specified. Use -n <namespace>."
  exit 1
fi

echo "Resource,Namespace,Name,CPU,Memory"

kubectl top "$RESOURCE" -n "$NAMESPACE" | tail -n +2 | while read -r name cpu mem; do
  echo "$RESOURCE,$NAMESPACE,$name,$cpu,$mem"
done